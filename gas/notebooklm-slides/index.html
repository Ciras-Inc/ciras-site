<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root {
      --primary: #1a73e8;
      --primary-hover: #1557b0;
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #dadce0;
      --text: #202124;
      --text-sub: #5f6368;
      --success: #0d904f;
      --error: #d93025;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 24px 16px; }
    h1 { font-size: 22px; font-weight: 500; margin-bottom: 20px; }

    .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 24px; gap: 4px; }
    .tab {
      padding: 10px 20px; cursor: pointer; border: none; background: none;
      font-size: 14px; color: var(--text-sub); border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: all 0.2s;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
    .card h2 { font-size: 16px; font-weight: 500; margin-bottom: 12px; }

    label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 4px; margin-top: 12px; }
    label:first-child { margin-top: 0; }
    input[type="text"], input[type="password"], select, textarea {
      width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px;
      font-size: 14px; color: var(--text); outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    textarea { resize: vertical; min-height: 60px; }

    .upload-area {
      border: 2px dashed var(--border); border-radius: 8px; padding: 32px;
      text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc;
    }
    .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: #e8f0fe; }
    .upload-area p { color: var(--text-sub); font-size: 14px; margin: 4px 0; }
    .upload-area .icon { font-size: 36px; color: var(--text-sub); }
    .file-list { margin-top: 12px; font-size: 13px; color: var(--text-sub); text-align: left; }
    .file-list div { padding: 4px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
    .file-list .remove { color: var(--error); cursor: pointer; font-size: 12px; }

    .btn { display: inline-block; padding: 10px 24px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 16px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { background: #94bef7; cursor: not-allowed; }
    .btn-secondary { background: #fff; color: var(--primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: #f1f3f4; }

    .result { padding: 16px; border-radius: 8px; margin-top: 16px; font-size: 14px; }
    .result.success { background: #e6f4ea; border: 1px solid #0d904f; color: #137333; }
    .result.error { background: #fce8e6; border: 1px solid var(--error); color: #c5221f; }
    .result a { color: var(--primary); font-weight: 500; }

    .progress { display: none; align-items: center; gap: 12px; margin-top: 16px; font-size: 14px; color: var(--text-sub); }
    .progress.show { display: flex; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 4px; height: 8px; margin-top: 8px; }
    .progress-bar { height: 8px; background: var(--primary); border-radius: 4px; transition: width 0.3s; }

    .structure-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 8px; }
    .structure-table th, .structure-table td { padding: 6px 8px; border: 1px solid var(--border); text-align: left; }
    .structure-table th { background: #f1f3f4; font-weight: 500; }
    .slide-header { background: #e8f0fe; font-weight: 500; color: var(--primary); }

    .share-info { font-size: 13px; margin-top: 8px; }
    .share-info dt { font-weight: 500; margin-top: 8px; }
    .share-info dd { margin-left: 12px; color: var(--text-sub); }

    .hidden { display: none; }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }

    .gemini-badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 11px; font-weight: 500; margin-left: 8px;
    }
    .gemini-badge.ok { background: #e6f4ea; color: #137333; }
    .gemini-badge.ng { background: #fce8e6; color: #c5221f; }
    .hint { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

    #debugLog {
      margin-top: 12px; padding: 12px; background: #1e1e1e; color: #d4d4d4;
      border-radius: 4px; font-size: 11px; font-family: 'Consolas', 'Monaco', monospace;
      max-height: 300px; overflow-y: auto; white-space: pre-wrap; display: none;
      line-height: 1.4;
    }
    #debugLog.show { display: block; }
    .log-ok { color: #4ec9b0; }
    .log-err { color: #f44747; }
    .log-warn { color: #dcdcaa; }
    .log-info { color: #9cdcfe; }
  </style>
</head>
<body>
<div class="container">
  <h1>NotebookLM スライド管理ツール</h1>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('create')">新規作成</button>
    <button class="tab" onclick="switchTab('edit')">編集</button>
    <button class="tab" onclick="switchTab('share')">共有管理</button>
  </div>

  <!-- ===== 新規作成タブ ===== -->
  <div id="tab-create" class="tab-content active">
    <div class="card">
      <h2>Gemini AI 設定 <span id="geminiStatus" class="gemini-badge ng">未設定</span></h2>
      <p class="hint">
        Gemini Vision API でスライド画像を解析し、テキスト・イラスト・背景を
        個別の編集可能な要素に分離します。
      </p>
      <label>Gemini API キー</label>
      <div style="display:flex; gap:8px">
        <input type="password" id="geminiApiKey" placeholder="AIza...">
        <button class="btn btn-secondary" onclick="saveApiKey()" style="margin-top:0;white-space:nowrap;height:36px">保存</button>
      </div>
      <p class="hint">
        <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a> で無料取得できます。
      </p>
      <div id="apiKeyResult"></div>
    </div>

    <div class="card">
      <h2>PDF をアップロード</h2>
      <div class="upload-area" id="dropZone"
           ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event)" onclick="document.getElementById('fileInput').click()">
        <div class="icon">&#128196;</div>
        <p>PDF ファイルをドラッグ＆ドロップ</p>
        <p style="font-size:12px">NotebookLM から出力した PDF に対応</p>
        <input type="file" id="fileInput" multiple accept=".pdf"
               onchange="handleFiles(this.files)" style="display:none">
      </div>
      <div class="file-list" id="fileList"></div>
    </div>

    <div class="card">
      <h2>設定</h2>
      <label>プレゼンテーション名</label>
      <input type="text" id="createTitle" value="NotebookLM スライド" placeholder="タイトルを入力">
      <label>共有設定</label>
      <select id="createShareMode" onchange="toggleEmailSection('create')">
        <option value="private">自分のみ（非公開）</option>
        <option value="link_view">リンクを知っている全員（閲覧のみ）</option>
        <option value="link_edit">リンクを知っている全員（編集可）</option>
        <option value="emails">メールアドレスで共有</option>
      </select>
      <div id="createEmailSection" class="hidden">
        <label>共有先メールアドレス（カンマ区切り）</label>
        <input type="text" id="createEmails" placeholder="user1@example.com, user2@example.com">
        <label>権限</label>
        <select id="createPermission">
          <option value="view">閲覧者</option>
          <option value="edit">編集者</option>
        </select>
      </div>
    </div>

    <button class="btn btn-primary" id="createBtn" onclick="startCreation()" disabled>
      Gemini AI でスライドを作成
    </button>
    <div class="progress" id="createProgress">
      <div class="spinner"></div>
      <span id="createProgressText">処理中...</span>
    </div>
    <div id="createProgressBar" class="hidden">
      <div class="progress-bar-container"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    </div>
    <div id="createResult"></div>
    <div id="debugLog"></div>
  </div>

  <!-- ===== 編集タブ ===== -->
  <div id="tab-edit" class="tab-content">
    <div class="card">
      <h2>プレゼンテーションを選択</h2>
      <div style="display:flex; gap:8px; align-items:end">
        <div style="flex:1">
          <label>プレゼンテーション</label>
          <select id="editPresentationSelect" onchange="onPresentationSelected()">
            <option value="">-- 読み込み中 --</option>
          </select>
        </div>
        <button class="btn btn-secondary" onclick="loadPresentations()" style="margin-top:0;height:36px">更新</button>
      </div>
      <label>または ID を直接入力</label>
      <div style="display:flex; gap:8px">
        <input type="text" id="editPresentationId" placeholder="プレゼンテーション ID">
        <button class="btn btn-secondary" onclick="loadStructure()" style="margin-top:0;white-space:nowrap;height:36px">読み込み</button>
      </div>
    </div>
    <div id="editPanel" class="hidden">
      <div class="card"><h2>スライド構成</h2><div id="structureView"></div></div>
      <div class="card">
        <h2>テキスト検索・置換</h2>
        <div class="row">
          <div><label>検索テキスト</label><input type="text" id="searchText" placeholder="検索するテキスト"></div>
          <div><label>置換テキスト</label><input type="text" id="replaceTextVal" placeholder="置換後のテキスト"></div>
        </div>
        <button class="btn btn-primary" onclick="doReplaceText()">置換実行</button>
        <div id="replaceResult"></div>
      </div>
      <div class="card">
        <h2>テキストボックスを追加</h2>
        <div class="row">
          <div><label>スライド番号</label><input type="text" id="tbSlide" value="1"></div>
          <div><label>フォントサイズ (pt)</label><input type="text" id="tbFontSize" value="18"></div>
        </div>
        <label>テキスト</label>
        <textarea id="tbText" placeholder="追加するテキストを入力"></textarea>
        <div class="row">
          <div><label>左 (pt)</label><input type="text" id="tbLeft" value="50"></div>
          <div><label>上 (pt)</label><input type="text" id="tbTop" value="50"></div>
          <div><label>幅 (pt)</label><input type="text" id="tbWidth" value="300"></div>
          <div><label>高さ (pt)</label><input type="text" id="tbHeight" value="50"></div>
        </div>
        <button class="btn btn-primary" onclick="doAddTextBox()">追加</button>
        <div id="tbResult"></div>
      </div>
      <div class="card">
        <h2>画像を差し替え</h2>
        <div class="row">
          <div><label>スライド番号</label><input type="text" id="imgSlide" value="1"></div>
          <div><label>画像番号</label><input type="text" id="imgIndex" value="1"></div>
        </div>
        <label>差し替え画像</label>
        <input type="file" id="imgFile" accept=".png,.jpg,.jpeg,.webp">
        <p style="font-size:12px;color:var(--text-sub);margin-top:4px">または画像URL:</p>
        <input type="text" id="imgUrl" placeholder="https://...">
        <button class="btn btn-primary" onclick="doReplaceImage()">差し替え</button>
        <div id="imgResult"></div>
      </div>
    </div>
    <div class="progress" id="editProgress"><div class="spinner"></div><span>処理中...</span></div>
  </div>

  <!-- ===== 共有管理タブ ===== -->
  <div id="tab-share" class="tab-content">
    <div class="card">
      <h2>プレゼンテーションを選択</h2>
      <label>プレゼンテーション ID</label>
      <input type="text" id="sharePresentationId" placeholder="プレゼンテーション ID を入力">
      <button class="btn btn-secondary" onclick="loadSharingInfo()">共有情報を取得</button>
    </div>
    <div id="sharePanel" class="hidden">
      <div class="card"><h2>現在の共有状態</h2><dl class="share-info" id="shareInfoView"></dl></div>
      <div class="card">
        <h2>共有設定を変更</h2>
        <label>共有モード</label>
        <select id="shareMode" onchange="toggleEmailSection('share')">
          <option value="private">自分のみ（非公開）</option>
          <option value="link_view">リンクを知っている全員（閲覧のみ）</option>
          <option value="link_edit">リンクを知っている全員（編集可）</option>
          <option value="emails">メールアドレスで共有</option>
        </select>
        <div id="shareEmailSection" class="hidden">
          <label>共有先メールアドレス（カンマ区切り）</label>
          <input type="text" id="shareEmails" placeholder="user@example.com">
          <label>権限</label>
          <select id="sharePermission"><option value="view">閲覧者</option><option value="edit">編集者</option></select>
        </div>
        <button class="btn btn-primary" onclick="doUpdateSharing()">共有設定を更新</button>
        <div id="shareResult"></div>
      </div>
    </div>
    <div class="progress" id="shareProgress"><div class="spinner"></div><span>処理中...</span></div>
  </div>
</div>

<script>
// ========================================================
// PDF.js 初期化
// ========================================================
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ========================================================
// グローバル変数
// ========================================================
var uploadedFiles = [];

// ========================================================
// デバッグログ
// ========================================================
function log(msg, cls) {
  var el = document.getElementById('debugLog');
  el.classList.add('show');
  var span = document.createElement('span');
  if (cls) span.className = cls;
  span.textContent = msg + '\n';
  el.appendChild(span);
  el.scrollTop = el.scrollHeight;
}
function logOk(msg) { log(msg, 'log-ok'); }
function logErr(msg) { log(msg, 'log-err'); }
function logWarn(msg) { log(msg, 'log-warn'); }
function logInfo(msg) { log(msg, 'log-info'); }

// ========================================================
// タブ切り替え
// ========================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'edit') loadPresentations();
}

// ========================================================
// Gemini API キー管理（ブラウザ localStorage に保存）
// ========================================================
function checkApiKey() {
  var key = localStorage.getItem('geminiApiKey');
  var badge = document.getElementById('geminiStatus');
  if (key) { badge.textContent = '設定済み'; badge.className = 'gemini-badge ok'; }
  else { badge.textContent = '未設定'; badge.className = 'gemini-badge ng'; }
}
function saveApiKey() {
  var key = document.getElementById('geminiApiKey').value.trim();
  if (!key) { showResult('apiKeyResult', 'error', 'API キーを入力してください。'); return; }
  localStorage.setItem('geminiApiKey', key);
  showResult('apiKeyResult', 'success', 'API キーをブラウザに保存しました。');
  document.getElementById('geminiApiKey').value = '';
  checkApiKey();
}
checkApiKey();

// ========================================================
// ファイルアップロード
// ========================================================
function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); handleFiles(e.dataTransfer.files); }
function handleFiles(fileList) { for (var i = 0; i < fileList.length; i++) uploadedFiles.push(fileList[i]); renderFileList(); }
function removeFile(index) { uploadedFiles.splice(index, 1); renderFileList(); }
function renderFileList() {
  var html = '';
  uploadedFiles.forEach(function(f, i) {
    var size = (f.size / 1024).toFixed(1) + ' KB';
    html += '<div><span>' + escHtml(f.name) + ' (' + size + ')</span>' +
            '<span class="remove" onclick="removeFile(' + i + ')">削除</span></div>';
  });
  document.getElementById('fileList').innerHTML = html;
  document.getElementById('createBtn').disabled = uploadedFiles.length === 0;
}

// ========================================================
// Canvas から領域を切り抜き（JPEG 高圧縮）
// ========================================================
function cropRegion(canvas, region, quality) {
  var sx = Math.round(region.x * canvas.width);
  var sy = Math.round(region.y * canvas.height);
  var sw = Math.round(region.width * canvas.width);
  var sh = Math.round(region.height * canvas.height);

  // 範囲チェック
  sx = Math.max(0, Math.min(sx, canvas.width - 1));
  sy = Math.max(0, Math.min(sy, canvas.height - 1));
  sw = Math.max(2, Math.min(sw, canvas.width - sx));
  sh = Math.max(2, Math.min(sh, canvas.height - sy));

  var crop = document.createElement('canvas');
  crop.width = sw;
  crop.height = sh;
  var ctx = crop.getContext('2d');
  ctx.drawImage(canvas, sx, sy, sw, sh, 0, 0, sw, sh);

  // JPEG で高圧縮（quality: 0.0-1.0）
  var dataUrl = crop.toDataURL('image/jpeg', quality || 0.6);
  var base64 = dataUrl.split(',')[1];
  crop.width = 0;
  crop.height = 0;
  return base64;
}

// ========================================================
// 解析用の低解像度 JPEG を生成
// ========================================================
function createAnalysisImage(highResCanvas) {
  // 解析用は低解像度で十分（800px幅程度）
  var ratio = 800 / highResCanvas.width;
  if (ratio > 1) ratio = 1;
  var lo = document.createElement('canvas');
  lo.width = Math.round(highResCanvas.width * ratio);
  lo.height = Math.round(highResCanvas.height * ratio);
  var ctx = lo.getContext('2d');
  ctx.drawImage(highResCanvas, 0, 0, lo.width, lo.height);
  var data = lo.toDataURL('image/jpeg', 0.7).split(',')[1];
  lo.width = 0;
  lo.height = 0;
  return data;
}

// ========================================================
// google.script.run ラッパー（Promise化）
// ========================================================
function callServer(funcName) {
  var args = Array.prototype.slice.call(arguments, 1);
  return new Promise(function(resolve, reject) {
    var runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
    runner[funcName].apply(runner, args);
  });
}

// ========================================================
// Gemini Vision API をブラウザから直接呼び出し
// GAS の UrlFetchApp を経由しないため権限・quota 問題を回避
// ========================================================
async function callGeminiApi(imageBase64, mimeType) {
  var apiKey = localStorage.getItem('geminiApiKey');
  if (!apiKey) throw new Error('Gemini API キーが設定されていません。設定画面で API キーを入力してください。');

  var url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey;

  var prompt = [
    'このプレゼンテーションスライド画像を正確に解析してください。',
    '',
    '以下のJSON形式で返してください:',
    '{',
    '  "backgroundColor": "#RRGGBB",',
    '  "elements": [',
    '    {',
    '      "type": "text",',
    '      "content": "テキスト内容",',
    '      "x": 0.1,',
    '      "y": 0.05,',
    '      "width": 0.8,',
    '      "height": 0.1,',
    '      "fontSize": 24,',
    '      "fontColor": "#333333",',
    '      "bold": false,',
    '      "alignment": "left"',
    '    },',
    '    {',
    '      "type": "image",',
    '      "description": "画像の説明",',
    '      "x": 0.05,',
    '      "y": 0.15,',
    '      "width": 0.4,',
    '      "height": 0.6',
    '    }',
    '  ]',
    '}',
    '',
    '■ 重要なルール:',
    '- x, y, width, height はスライド全体に対する割合（0.0〜1.0）で指定',
    '- 座標は左上を原点とする',
    '',
    '■ テキスト要素 (type: "text"):',
    '- すべてのテキストを検出（見出し、本文、キャプション、吹き出し内テキスト、ラベル等）',
    '- content にテキスト内容を正確に含める（改行は \\n で）',
    '- fontSize はポイント単位の推定値',
    '- fontColor はテキスト色（#RRGGBB形式）',
    '- bold: 太字なら true',
    '- alignment: "left", "center", "right" のいずれか',
    '- 論理的にまとまるテキストは1要素にグループ化（ただし離れた位置のテキストは別要素に）',
    '',
    '■ 画像要素 (type: "image"):',
    '- イラスト、写真、アイコン、図表、装飾グラフィック（花、人物画、仏具等）の矩形領域',
    '- テキストのみの領域は含めない',
    '- 各画像領域はなるべく重複なく、正確な境界で切り出す',
    '- description に画像内容の簡単な説明',
    '',
    '■ backgroundColor:',
    '- スライド全体の主要な背景色（#RRGGBB形式）',
    '',
    '有効な JSON のみを返すこと。説明文やマークダウンは不要。'
  ].join('\n');

  var payload = {
    contents: [{
      parts: [
        { text: prompt },
        { inlineData: { mimeType: mimeType || 'image/jpeg', data: imageBase64 } }
      ]
    }],
    generationConfig: {
      temperature: 0.1,
      maxOutputTokens: 8192,
      responseMimeType: 'application/json'
    }
  };

  // リトライ付きリクエスト（429対策: 最大3回、指数バックオフ）
  var maxRetries = 3;
  var waitMs = [5000, 15000, 30000];
  var lastError = null;

  for (var attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      var resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (resp.ok) {
        var data = await resp.json();
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
          throw new Error('Gemini API: 有効な応答がありません。');
        }

        var text = data.candidates[0].content.parts[0].text;
        // JSON抽出（マークダウンブロック内の場合）
        var jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (jsonMatch) text = jsonMatch[1];
        text = text.trim();

        var analysis = JSON.parse(text);
        if (!analysis.elements || !Array.isArray(analysis.elements)) {
          throw new Error('Gemini 応答に elements 配列がありません');
        }

        var textCount = 0, imageCount = 0;
        for (var i = 0; i < analysis.elements.length; i++) {
          if (analysis.elements[i].type === 'text') textCount++;
          else if (analysis.elements[i].type === 'image') imageCount++;
        }

        return {
          analysis: analysis,
          stats: {
            textElements: textCount,
            imageElements: imageCount,
            backgroundColor: analysis.backgroundColor || '#FFFFFF'
          }
        };
      }

      // エラーレスポンス
      var errBody = await resp.text();
      if (resp.status === 429 && attempt < maxRetries) {
        logWarn('  Gemini API 429: ' + (waitMs[attempt] / 1000) + '秒待機後リトライ (' + (attempt + 1) + '/' + maxRetries + ')');
        await sleep(waitMs[attempt]);
        continue;
      }
      lastError = new Error('Gemini API エラー (HTTP ' + resp.status + '): ' + errBody.substring(0, 300));
    } catch (e) {
      if (e.message && e.message.indexOf('Gemini API') !== -1) {
        lastError = e;
      } else {
        lastError = new Error('Gemini API 通信エラー: ' + e.message);
      }
      if (attempt < maxRetries) {
        logWarn('  通信エラー、' + (waitMs[attempt] / 1000) + '秒後リトライ (' + (attempt + 1) + '/' + maxRetries + ')');
        await sleep(waitMs[attempt]);
        continue;
      }
    }
  }

  throw lastError || new Error('Gemini API: 原因不明のエラー');
}

// ========================================================
// メイン作成フロー
// ========================================================
async function startCreation() {
  if (uploadedFiles.length === 0) return;

  var btn = document.getElementById('createBtn');
  btn.disabled = true;
  document.getElementById('createResult').innerHTML = '';
  document.getElementById('debugLog').innerHTML = '';
  document.getElementById('debugLog').classList.remove('show');
  document.getElementById('createProgressBar').classList.remove('hidden');
  showProgress('createProgress', '処理を開始...');

  try {
    await processWithGemini();
  } catch (err) {
    hideProgress('createProgress');
    document.getElementById('createProgressBar').classList.add('hidden');
    showResult('createResult', 'error', escHtml(err.message || String(err)));
    logErr('致命的エラー: ' + (err.message || String(err)));
  } finally {
    btn.disabled = false;
  }
}

// ========================================================
// Gemini AI 解析フロー
// 1ページずつ: レンダリング → Gemini解析 → 画像切り抜き → スライド作成
// ========================================================
async function processWithGemini() {
  var title = document.getElementById('createTitle').value;
  var shareMode = document.getElementById('createShareMode').value;
  var emails = document.getElementById('createEmails').value;
  var permission = document.getElementById('createPermission').value;

  // 全ページを収集
  var pages = []; // {canvas, fileLabel}
  for (var f = 0; f < uploadedFiles.length; f++) {
    var file = uploadedFiles[f];
    if (file.type !== 'application/pdf') continue;

    var ab = await file.arrayBuffer();
    var pdf = await pdfjsLib.getDocument({ data: ab }).promise;
    logInfo('PDF: ' + file.name + ' (' + pdf.numPages + 'ページ)');

    for (var p = 1; p <= pdf.numPages; p++) {
      var page = await pdf.getPage(p);
      var viewport = page.getViewport({ scale: 2.0 });
      var canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      var ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport: viewport }).promise;
      pages.push({ canvas: canvas, label: file.name + ' p.' + p });
    }
  }

  if (pages.length === 0) throw new Error('PDFページがありません。');
  logInfo('合計 ' + pages.length + ' ページを処理します');

  var presentationId = null;

  for (var i = 0; i < pages.length; i++) {
    var pg = pages[i];
    var pct = (i / pages.length) * 100;
    updateProgress(pg.label + ' を処理中... (' + (i + 1) + '/' + pages.length + ')', pct);

    // ページ間に3秒待機（429レート制限対策、初回は不要）
    if (i > 0) {
      logInfo('  レート制限対策: 3秒待機中...');
      await sleep(3000);
    }

    // ステップ1: 低解像度画像を Gemini に送信して解析
    logInfo('--- ページ ' + (i + 1) + ': ' + pg.label + ' ---');
    log('  [1] Gemini に解析リクエスト送信...');

    var analysisImage = createAnalysisImage(pg.canvas);
    logInfo('  解析用画像サイズ: ' + (analysisImage.length / 1024).toFixed(0) + ' KB');

    var geminiResult;
    try {
      geminiResult = await callGeminiApi(analysisImage, 'image/jpeg');
    } catch (e) {
      logErr('  Gemini 解析エラー: ' + e.message);
      logErr('  このページはスキップします');
      pg.canvas.width = 0;
      pg.canvas.height = 0;
      continue;
    }

    var analysis = geminiResult.analysis;
    var stats = geminiResult.stats;
    logOk('  [2] Gemini 解析完了: テキスト=' + stats.textElements + '個, 画像=' + stats.imageElements + '個, 背景色=' + stats.backgroundColor);

    // 要素の詳細をログ
    for (var ei = 0; ei < analysis.elements.length; ei++) {
      var elem = analysis.elements[ei];
      if (elem.type === 'text') {
        var preview = (elem.content || '').substring(0, 50).replace(/\n/g, ' ');
        log('    text: "' + preview + '..." @ (' + (elem.x||0).toFixed(2) + ',' + (elem.y||0).toFixed(2) + ') ' + (elem.fontSize||14) + 'pt', 'log-info');
      } else if (elem.type === 'image') {
        log('    image: ' + (elem.description||'?') + ' @ (' + (elem.x||0).toFixed(2) + ',' + (elem.y||0).toFixed(2) + ') ' + Math.round((elem.width||0)*100) + '%x' + Math.round((elem.height||0)*100) + '%', 'log-warn');
      }
    }

    // ステップ2: 画像領域をキャンバスから切り抜き
    log('  [3] 画像領域を切り抜き中...');
    var pageData = buildPageData(analysis, pg.canvas);

    // キャンバスを解放
    pg.canvas.width = 0;
    pg.canvas.height = 0;

    logOk('  切り抜き完了: テキスト=' + pageData.texts.length + '個, 画像=' + pageData.images.length + '個');

    // データサイズを確認
    var dataSize = JSON.stringify(pageData).length;
    logInfo('  送信データサイズ: ' + (dataSize / 1024).toFixed(0) + ' KB');

    if (dataSize > 9 * 1024 * 1024) {
      logWarn('  データが大きすぎます (9MB超)。画像品質を下げて再圧縮...');
      // 画像を再圧縮
      pageData = buildPageData(analysis, null, 0.3);
      if (!pageData) {
        logErr('  再圧縮に失敗。テキストのみで作成します。');
        pageData = { backgroundColor: analysis.backgroundColor || '#FFFFFF', texts: [], images: [] };
        for (var ei = 0; ei < analysis.elements.length; ei++) {
          if (analysis.elements[ei].type === 'text') {
            pageData.texts.push(analysis.elements[ei]);
          }
        }
      }
    }

    // ステップ3: サーバーに送信してスライド作成
    log('  [4] サーバーにスライドデータ送信中...');

    try {
      if (presentationId === null) {
        var result = await callServer('createSingleSlidePresentation', {
          pageData: pageData,
          title: title,
          shareMode: shareMode,
          emails: emails,
          permission: permission
        });
        presentationId = result.id;
        logOk('  プレゼンテーション作成: ' + presentationId);
      } else {
        await callServer('addSingleSlide', {
          presentationId: presentationId,
          pageData: pageData
        });
        logOk('  スライド追加完了');
      }
    } catch (e) {
      logErr('  スライド作成エラー: ' + e.message);

      // 画像なしでリトライ
      logWarn('  画像なしでリトライ...');
      var textOnlyData = {
        backgroundColor: pageData.backgroundColor,
        texts: pageData.texts,
        images: []
      };
      try {
        if (presentationId === null) {
          var result = await callServer('createSingleSlidePresentation', {
            pageData: textOnlyData,
            title: title,
            shareMode: shareMode,
            emails: emails,
            permission: permission
          });
          presentationId = result.id;
          logOk('  テキストのみでプレゼンテーション作成: ' + presentationId);
        } else {
          await callServer('addSingleSlide', {
            presentationId: presentationId,
            pageData: textOnlyData
          });
          logOk('  テキストのみでスライド追加完了');
        }
      } catch (e2) {
        logErr('  リトライも失敗: ' + e2.message);
      }
    }
  }

  if (!presentationId) throw new Error('スライドを1ページも作成できませんでした。デバッグログを確認してください。');

  // 完了
  hideProgress('createProgress');
  document.getElementById('createProgressBar').classList.add('hidden');
  var url = 'https://docs.google.com/presentation/d/' + presentationId + '/edit';
  showResult('createResult', 'success',
    '<strong>' + escHtml(title) + '</strong> を作成しました（' + pages.length + ' スライド）<br>' +
    '<a href="' + url + '" target="_blank">Google スライドを開く</a><br>' +
    '<span style="font-size:12px;color:var(--text-sub)">テキスト・画像・背景が個別の編集可能な要素として配置されています。</span>'
  );
  logOk('=== 完了 ===');
  uploadedFiles = [];
  renderFileList();
}

// ========================================================
// Gemini 解析結果 + Canvas から pageData を構築
// ========================================================
function buildPageData(analysis, canvas, overrideQuality) {
  var pageData = {
    backgroundColor: analysis.backgroundColor || '#FFFFFF',
    texts: [],
    images: []
  };

  var elements = analysis.elements || [];

  for (var i = 0; i < elements.length; i++) {
    var el = elements[i];

    if (el.type === 'text') {
      pageData.texts.push({
        content: el.content || '',
        x: el.x || 0,
        y: el.y || 0,
        width: el.width || 0.1,
        height: el.height || 0.05,
        fontSize: el.fontSize || 14,
        fontColor: el.fontColor || '#333333',
        bold: el.bold || false,
        alignment: el.alignment || 'left'
      });
    } else if (el.type === 'image' && canvas) {
      // Canvas から画像領域を切り抜き
      var quality = overrideQuality || 0.5;
      var cropped = cropRegion(canvas, {
        x: el.x || 0,
        y: el.y || 0,
        width: el.width || 0.1,
        height: el.height || 0.1
      }, quality);

      if (cropped) {
        pageData.images.push({
          data: cropped,
          mimeType: 'image/jpeg',
          x: el.x || 0,
          y: el.y || 0,
          width: el.width || 0.1,
          height: el.height || 0.1
        });
      }
    }
  }

  return pageData;
}

// ========================================================
// ユーティリティ
// ========================================================
function sleep(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

function updateProgress(text, percent) {
  showProgress('createProgress', text);
  if (percent !== undefined) document.getElementById('progressBar').style.width = Math.round(percent) + '%';
}

// ========================================================
// 編集機能
// ========================================================
function loadPresentations() {
  google.script.run.withSuccessHandler(function(list) {
    var sel = document.getElementById('editPresentationSelect');
    sel.innerHTML = '<option value="">-- 選択してください --</option>';
    list.forEach(function(p) {
      var date = new Date(p.lastUpdated).toLocaleDateString('ja-JP');
      sel.innerHTML += '<option value="' + p.id + '">' + escHtml(p.name) + ' (' + date + ')</option>';
    });
  }).listMyPresentations();
}
function onPresentationSelected() {
  var id = document.getElementById('editPresentationSelect').value;
  if (id) { document.getElementById('editPresentationId').value = id; loadStructure(); }
}
function loadStructure() {
  var id = getEditId(); if (!id) return;
  showProgress('editProgress');
  google.script.run
    .withSuccessHandler(function(s) { hideProgress('editProgress'); document.getElementById('editPanel').classList.remove('hidden'); renderStructure(s); })
    .withFailureHandler(function(e) { hideProgress('editProgress'); showResult('structureView', 'error', escHtml(e.message)); })
    .getSlideStructure(id);
}
function renderStructure(structure) {
  var html = '<table class="structure-table"><tr><th>#</th><th>種類</th><th>位置</th><th>サイズ</th><th>内容</th></tr>';
  structure.forEach(function(s) {
    html += '<tr class="slide-header"><td colspan="5">スライド ' + s.slideNumber + '</td></tr>';
    s.elements.forEach(function(el) {
      var content = '';
      if (el.type === 'SHAPE' && el.text) content = escHtml(el.text.substring(0, 60));
      else if (el.type === 'IMAGE') content = '[画像]';
      html += '<tr><td>' + el.index + '</td><td>' + el.type + '</td><td>' + el.left + ', ' + el.top + '</td><td>' + el.width + ' x ' + el.height + '</td><td>' + content + '</td></tr>';
    });
  });
  html += '</table>';
  document.getElementById('structureView').innerHTML = html;
}
function doReplaceText() {
  var id = getEditId(), s = document.getElementById('searchText').value, r = document.getElementById('replaceTextVal').value;
  if (!id || !s) return;
  google.script.run.withSuccessHandler(function(c) { showResult('replaceResult', 'success', c + ' 箇所を置換しました。'); loadStructure(); })
    .withFailureHandler(function(e) { showResult('replaceResult', 'error', escHtml(e.message)); }).replaceText(id, s, r);
}
function doAddTextBox() {
  var id = getEditId(); if (!id) return;
  var sn = parseInt(document.getElementById('tbSlide').value)||1, txt = document.getElementById('tbText').value,
      l = parseFloat(document.getElementById('tbLeft').value)||50, t = parseFloat(document.getElementById('tbTop').value)||50,
      w = parseFloat(document.getElementById('tbWidth').value)||300, h = parseFloat(document.getElementById('tbHeight').value)||50,
      fs = parseInt(document.getElementById('tbFontSize').value)||18;
  google.script.run.withSuccessHandler(function() { showResult('tbResult', 'success', 'テキストボックスを追加しました。'); loadStructure(); })
    .withFailureHandler(function(e) { showResult('tbResult', 'error', escHtml(e.message)); }).addTextBox(id, sn, txt, l, t, w, h, fs);
}
function doReplaceImage() {
  var id = getEditId(); if (!id) return;
  var sn = parseInt(document.getElementById('imgSlide').value)||1, idx = parseInt(document.getElementById('imgIndex').value)||1;
  var url = document.getElementById('imgUrl').value.trim(), fi = document.getElementById('imgFile');
  if (url) {
    google.script.run.withSuccessHandler(function() { showResult('imgResult', 'success', '画像を差し替えました。'); loadStructure(); })
      .withFailureHandler(function(e) { showResult('imgResult', 'error', escHtml(e.message)); }).replaceImage(id, sn, idx, {url:url});
  } else if (fi.files.length > 0) {
    var reader = new FileReader(); reader.onload = function() {
      var d = {data: reader.result.split(',')[1], mimeType: fi.files[0].type, fileName: fi.files[0].name};
      google.script.run.withSuccessHandler(function() { showResult('imgResult', 'success', '画像を差し替えました。'); loadStructure(); })
        .withFailureHandler(function(e) { showResult('imgResult', 'error', escHtml(e.message)); }).replaceImage(id, sn, idx, d);
    }; reader.readAsDataURL(fi.files[0]);
  } else { showResult('imgResult', 'error', '画像ファイルまたは URL を指定してください。'); }
}

// ========================================================
// 共有管理
// ========================================================
function loadSharingInfo() {
  var id = document.getElementById('sharePresentationId').value.trim(); if (!id) return;
  showProgress('shareProgress');
  google.script.run.withSuccessHandler(function(info) { hideProgress('shareProgress'); document.getElementById('sharePanel').classList.remove('hidden'); renderSharingInfo(info); })
    .withFailureHandler(function(e) { hideProgress('shareProgress'); showResult('shareResult', 'error', escHtml(e.message)); }).getSharingInfo(id);
}
function renderSharingInfo(info) {
  var am = {'ANYONE':'全員','ANYONE_WITH_LINK':'リンクを知っている全員','DOMAIN':'ドメイン内','PRIVATE':'非公開'};
  var pm = {'VIEW':'閲覧のみ','EDIT':'編集可','COMMENT':'コメント可','NONE':'なし'};
  var h = '<dt>アクセス範囲</dt><dd>'+(am[info.access]||info.access)+'</dd>';
  h += '<dt>権限</dt><dd>'+(pm[info.permission]||info.permission)+'</dd>';
  h += '<dt>編集者</dt><dd>'+(info.editors.length>0?escHtml(info.editors.join(', ')):'なし')+'</dd>';
  h += '<dt>閲覧者</dt><dd>'+(info.viewers.length>0?escHtml(info.viewers.join(', ')):'なし')+'</dd>';
  h += '<dt>URL</dt><dd><a href="'+info.url+'" target="_blank">'+escHtml(info.url)+'</a></dd>';
  document.getElementById('shareInfoView').innerHTML = h;
}
function doUpdateSharing() {
  var id = document.getElementById('sharePresentationId').value.trim(); if (!id) return;
  google.script.run.withSuccessHandler(function(info) { showResult('shareResult', 'success', '共有設定を更新しました。'); renderSharingInfo(info); })
    .withFailureHandler(function(e) { showResult('shareResult', 'error', escHtml(e.message)); })
    .updateSharing(id, document.getElementById('shareMode').value, document.getElementById('shareEmails').value, document.getElementById('sharePermission').value);
}

// ========================================================
// 共通ユーティリティ
// ========================================================
function getEditId() { return document.getElementById('editPresentationId').value.trim(); }
function toggleEmailSection(prefix) {
  var mode = document.getElementById(prefix + (prefix === 'create' ? 'ShareMode' : 'Mode')).value;
  document.getElementById(prefix + 'EmailSection').classList.toggle('hidden', mode !== 'emails');
}
function showProgress(id, text) { var el = document.getElementById(id); el.classList.add('show'); if (text) { var s = el.querySelector('span'); if (s) s.textContent = text; } }
function hideProgress(id) { document.getElementById(id).classList.remove('show'); }
function showResult(cid, type, html) { document.getElementById(cid).innerHTML = '<div class="result '+type+'">'+html+'</div>'; }
function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
</script>
</body>
</html>
