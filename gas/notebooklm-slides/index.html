<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root {
      --primary: #1a73e8;
      --primary-hover: #1557b0;
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #dadce0;
      --text: #202124;
      --text-sub: #5f6368;
      --success: #0d904f;
      --error: #d93025;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 24px 16px; }
    h1 { font-size: 22px; font-weight: 500; margin-bottom: 20px; }

    .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 24px; gap: 4px; }
    .tab {
      padding: 10px 20px; cursor: pointer; border: none; background: none;
      font-size: 14px; color: var(--text-sub); border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: all 0.2s;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
    .card h2 { font-size: 16px; font-weight: 500; margin-bottom: 12px; }

    label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 4px; margin-top: 12px; }
    label:first-child { margin-top: 0; }
    input[type="text"], input[type="password"], select, textarea {
      width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px;
      font-size: 14px; color: var(--text); outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    textarea { resize: vertical; min-height: 60px; }

    .upload-area {
      border: 2px dashed var(--border); border-radius: 8px; padding: 32px;
      text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc;
    }
    .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: #e8f0fe; }
    .upload-area p { color: var(--text-sub); font-size: 14px; margin: 4px 0; }
    .upload-area .icon { font-size: 36px; color: var(--text-sub); }
    .file-list { margin-top: 12px; font-size: 13px; color: var(--text-sub); text-align: left; }
    .file-list div { padding: 4px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
    .file-list .remove { color: var(--error); cursor: pointer; font-size: 12px; }

    .btn { display: inline-block; padding: 10px 24px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 16px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { background: #94bef7; cursor: not-allowed; }
    .btn-secondary { background: #fff; color: var(--primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: #f1f3f4; }

    .result { padding: 16px; border-radius: 8px; margin-top: 16px; font-size: 14px; }
    .result.success { background: #e6f4ea; border: 1px solid #0d904f; color: #137333; }
    .result.error { background: #fce8e6; border: 1px solid var(--error); color: #c5221f; }
    .result a { color: var(--primary); font-weight: 500; }

    .progress { display: none; align-items: center; gap: 12px; margin-top: 16px; font-size: 14px; color: var(--text-sub); }
    .progress.show { display: flex; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 4px; height: 8px; margin-top: 8px; }
    .progress-bar { height: 8px; background: var(--primary); border-radius: 4px; transition: width 0.3s; }

    .structure-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 8px; }
    .structure-table th, .structure-table td { padding: 6px 8px; border: 1px solid var(--border); text-align: left; }
    .structure-table th { background: #f1f3f4; font-weight: 500; }
    .slide-header { background: #e8f0fe; font-weight: 500; color: var(--primary); }

    .share-info { font-size: 13px; margin-top: 8px; }
    .share-info dt { font-weight: 500; margin-top: 8px; }
    .share-info dd { margin-left: 12px; color: var(--text-sub); }

    .hidden { display: none; }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }

    .hint { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

    .debug-log { margin-top: 12px; padding: 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace; max-height: 200px; overflow-y: auto; white-space: pre-wrap; display: none; }
    .debug-log.show { display: block; }
  </style>
</head>
<body>
<div class="container">
  <h1>NotebookLM スライド管理ツール</h1>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('create')">新規作成</button>
    <button class="tab" onclick="switchTab('edit')">編集</button>
    <button class="tab" onclick="switchTab('share')">共有管理</button>
  </div>

  <!-- ===== 新規作成タブ ===== -->
  <div id="tab-create" class="tab-content active">
    <div class="card">
      <h2>PDF ネイティブ要素抽出</h2>
      <p class="hint">
        PDF の内部構造からテキストと画像を直接抽出します。
        ラスタライズ（画像化）せずに、PDF に埋め込まれたテキスト・画像・背景を
        個別の編集可能な要素として Google スライドに再構築します。
      </p>
    </div>

    <div class="card">
      <h2>ファイルをアップロード</h2>
      <div class="upload-area" id="dropZone"
           ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event)" onclick="document.getElementById('fileInput').click()">
        <div class="icon">&#128196;</div>
        <p>PDF ファイルをドラッグ＆ドロップ</p>
        <p style="font-size:12px">PDF に対応（複数選択可）</p>
        <input type="file" id="fileInput" multiple
               accept=".pdf"
               onchange="handleFiles(this.files)" style="display:none">
      </div>
      <div class="file-list" id="fileList"></div>
    </div>

    <div class="card">
      <h2>設定</h2>
      <label>プレゼンテーション名</label>
      <input type="text" id="createTitle" value="NotebookLM スライド" placeholder="タイトルを入力">
      <label>共有設定</label>
      <select id="createShareMode" onchange="toggleEmailSection('create')">
        <option value="private">自分のみ（非公開）</option>
        <option value="link_view">リンクを知っている全員（閲覧のみ）</option>
        <option value="link_edit">リンクを知っている全員（編集可）</option>
        <option value="emails">メールアドレスで共有</option>
      </select>
      <div id="createEmailSection" class="hidden">
        <label>共有先メールアドレス（カンマ区切り）</label>
        <input type="text" id="createEmails" placeholder="user1@example.com, user2@example.com">
        <label>権限</label>
        <select id="createPermission">
          <option value="view">閲覧者</option>
          <option value="edit">編集者</option>
        </select>
      </div>
    </div>

    <button class="btn btn-primary" id="createBtn" onclick="startCreation()" disabled>
      スライドを作成
    </button>
    <div class="progress" id="createProgress">
      <div class="spinner"></div>
      <span id="createProgressText">処理中...</span>
    </div>
    <div id="createProgressBar" class="hidden">
      <div class="progress-bar-container"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    </div>
    <div id="createResult"></div>
    <div class="debug-log" id="debugLog"></div>
  </div>

  <!-- ===== 編集タブ ===== -->
  <div id="tab-edit" class="tab-content">
    <div class="card">
      <h2>プレゼンテーションを選択</h2>
      <div style="display:flex; gap:8px; align-items:end">
        <div style="flex:1">
          <label>プレゼンテーション</label>
          <select id="editPresentationSelect" onchange="onPresentationSelected()">
            <option value="">-- 読み込み中 --</option>
          </select>
        </div>
        <button class="btn btn-secondary" onclick="loadPresentations()" style="margin-top:0;height:36px">更新</button>
      </div>
      <label>または ID を直接入力</label>
      <div style="display:flex; gap:8px">
        <input type="text" id="editPresentationId" placeholder="プレゼンテーション ID">
        <button class="btn btn-secondary" onclick="loadStructure()" style="margin-top:0;white-space:nowrap;height:36px">読み込み</button>
      </div>
    </div>
    <div id="editPanel" class="hidden">
      <div class="card"><h2>スライド構成</h2><div id="structureView"></div></div>
      <div class="card">
        <h2>テキスト検索・置換</h2>
        <div class="row">
          <div><label>検索テキスト</label><input type="text" id="searchText" placeholder="検索するテキスト"></div>
          <div><label>置換テキスト</label><input type="text" id="replaceTextVal" placeholder="置換後のテキスト"></div>
        </div>
        <button class="btn btn-primary" onclick="doReplaceText()">置換実行</button>
        <div id="replaceResult"></div>
      </div>
      <div class="card">
        <h2>テキストボックスを追加</h2>
        <div class="row">
          <div><label>スライド番号</label><input type="text" id="tbSlide" value="1"></div>
          <div><label>フォントサイズ (pt)</label><input type="text" id="tbFontSize" value="18"></div>
        </div>
        <label>テキスト</label>
        <textarea id="tbText" placeholder="追加するテキストを入力"></textarea>
        <div class="row">
          <div><label>左 (pt)</label><input type="text" id="tbLeft" value="50"></div>
          <div><label>上 (pt)</label><input type="text" id="tbTop" value="50"></div>
          <div><label>幅 (pt)</label><input type="text" id="tbWidth" value="300"></div>
          <div><label>高さ (pt)</label><input type="text" id="tbHeight" value="50"></div>
        </div>
        <button class="btn btn-primary" onclick="doAddTextBox()">追加</button>
        <div id="tbResult"></div>
      </div>
      <div class="card">
        <h2>画像を差し替え</h2>
        <div class="row">
          <div><label>スライド番号</label><input type="text" id="imgSlide" value="1"></div>
          <div><label>画像番号</label><input type="text" id="imgIndex" value="1"></div>
        </div>
        <label>差し替え画像</label>
        <input type="file" id="imgFile" accept=".png,.jpg,.jpeg,.webp">
        <p style="font-size:12px;color:var(--text-sub);margin-top:4px">または画像URL:</p>
        <input type="text" id="imgUrl" placeholder="https://...">
        <button class="btn btn-primary" onclick="doReplaceImage()">差し替え</button>
        <div id="imgResult"></div>
      </div>
    </div>
    <div class="progress" id="editProgress"><div class="spinner"></div><span>処理中...</span></div>
  </div>

  <!-- ===== 共有管理タブ ===== -->
  <div id="tab-share" class="tab-content">
    <div class="card">
      <h2>プレゼンテーションを選択</h2>
      <label>プレゼンテーション ID</label>
      <input type="text" id="sharePresentationId" placeholder="プレゼンテーション ID を入力">
      <button class="btn btn-secondary" onclick="loadSharingInfo()">共有情報を取得</button>
    </div>
    <div id="sharePanel" class="hidden">
      <div class="card"><h2>現在の共有状態</h2><dl class="share-info" id="shareInfoView"></dl></div>
      <div class="card">
        <h2>共有設定を変更</h2>
        <label>共有モード</label>
        <select id="shareMode" onchange="toggleEmailSection('share')">
          <option value="private">自分のみ（非公開）</option>
          <option value="link_view">リンクを知っている全員（閲覧のみ）</option>
          <option value="link_edit">リンクを知っている全員（編集可）</option>
          <option value="emails">メールアドレスで共有</option>
        </select>
        <div id="shareEmailSection" class="hidden">
          <label>共有先メールアドレス（カンマ区切り）</label>
          <input type="text" id="shareEmails" placeholder="user@example.com">
          <label>権限</label>
          <select id="sharePermission"><option value="view">閲覧者</option><option value="edit">編集者</option></select>
        </div>
        <button class="btn btn-primary" onclick="doUpdateSharing()">共有設定を更新</button>
        <div id="shareResult"></div>
      </div>
    </div>
    <div class="progress" id="shareProgress"><div class="spinner"></div><span>処理中...</span></div>
  </div>
</div>

<script>
// ========================================================
// PDF.js 初期化
// ========================================================
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

var OPS = pdfjsLib.OPS;

// ========================================================
// グローバル変数
// ========================================================
var uploadedFiles = [];
var BATCH_SIZE = 3;

// ========================================================
// デバッグログ
// ========================================================
function debugLog(msg) {
  var el = document.getElementById('debugLog');
  el.classList.add('show');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
}

// ========================================================
// タブ切り替え
// ========================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'edit') loadPresentations();
}

// ========================================================
// ファイルアップロード
// ========================================================
function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); handleFiles(e.dataTransfer.files); }
function handleFiles(fileList) { for (var i = 0; i < fileList.length; i++) uploadedFiles.push(fileList[i]); renderFileList(); }
function removeFile(index) { uploadedFiles.splice(index, 1); renderFileList(); }
function renderFileList() {
  var html = '';
  uploadedFiles.forEach(function(f, i) {
    var size = (f.size / 1024).toFixed(1) + ' KB';
    html += '<div><span>' + escHtml(f.name) + ' (' + size + ')</span>' +
            '<span class="remove" onclick="removeFile(' + i + ')">削除</span></div>';
  });
  document.getElementById('fileList').innerHTML = html;
  document.getElementById('createBtn').disabled = uploadedFiles.length === 0;
}

// ========================================================
// PDF ネイティブ要素抽出: テキスト
// ========================================================

/**
 * page.getTextContent() からテキスト要素を抽出
 * PDF座標系（左下原点）→ 正規化座標（左上原点、0-1）に変換
 */
async function extractTextElements(page) {
  var viewport = page.getViewport({ scale: 1.0 });
  var pageWidth = viewport.width;
  var pageHeight = viewport.height;

  var textContent = await page.getTextContent();
  var items = textContent.items;
  var textElements = [];

  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    if (!item.str || !item.str.trim()) continue;

    // transform: [scaleX, skewY, skewX, scaleY, translateX, translateY]
    var tx = item.transform;
    var fontSize = Math.abs(tx[3]) || Math.abs(tx[0]) || 12;
    var x = tx[4];
    var y = tx[5];

    // PDF座標（左下原点）→ 画面座標（左上原点）
    var topY = pageHeight - y - fontSize;

    // 幅の推定: item.width が利用可能
    var w = item.width || (item.str.length * fontSize * 0.6);
    var h = fontSize * 1.3;

    textElements.push({
      content: item.str,
      x: x / pageWidth,
      y: topY / pageHeight,
      width: w / pageWidth,
      height: h / pageHeight,
      fontSize: fontSize,
      fontName: item.fontName || '',
      // ページ座標での実際の値も保持
      rawX: x,
      rawY: y
    });
  }

  return textElements;
}

/**
 * 近接するテキスト要素をグループ化して論理的なテキストブロックにする
 * 同じY座標（行）のテキストを結合し、近い行をグループ化
 */
function groupTextElements(elements, pageWidth, pageHeight) {
  if (elements.length === 0) return [];

  // Y座標（rawY）でソート（PDF座標: 大きい方が上）
  elements.sort(function(a, b) { return b.rawY - a.rawY; });

  // 同じ行のテキストをグループ化（Y座標が近い = 同じ行）
  var lines = [];
  var currentLine = [elements[0]];
  var currentY = elements[0].rawY;

  for (var i = 1; i < elements.length; i++) {
    var el = elements[i];
    var yDiff = Math.abs(el.rawY - currentY);
    // 同じ行とみなす閾値: フォントサイズの50%以内
    if (yDiff < (el.fontSize * 0.5)) {
      currentLine.push(el);
    } else {
      // X座標でソートして行を確定
      currentLine.sort(function(a, b) { return a.rawX - b.rawX; });
      lines.push(currentLine);
      currentLine = [el];
      currentY = el.rawY;
    }
  }
  currentLine.sort(function(a, b) { return a.rawX - b.rawX; });
  lines.push(currentLine);

  // 各行のテキストを結合
  var lineData = lines.map(function(line) {
    var text = line.map(function(el) { return el.content; }).join('');
    var minX = Math.min.apply(null, line.map(function(el) { return el.x; }));
    var maxRight = Math.max.apply(null, line.map(function(el) { return el.x + el.width; }));
    var avgY = line[0].y;
    var maxFontSize = Math.max.apply(null, line.map(function(el) { return el.fontSize; }));
    var avgHeight = maxFontSize * 1.3 / pageHeight;

    return {
      content: text,
      x: minX,
      y: avgY,
      width: maxRight - minX,
      height: avgHeight,
      fontSize: maxFontSize,
      fontName: line[0].fontName,
      rawY: line[0].rawY
    };
  });

  // 近接する行をブロック化（同じフォントサイズで連続する行）
  var blocks = [];
  var currentBlock = [lineData[0]];

  for (var i = 1; i < lineData.length; i++) {
    var prev = lineData[i - 1];
    var curr = lineData[i];
    var lineGap = Math.abs(prev.rawY - curr.rawY);
    var expectedGap = prev.fontSize * 2.0; // 行間の閾値
    var sameFontSize = Math.abs(prev.fontSize - curr.fontSize) < 2;

    if (lineGap < expectedGap && sameFontSize) {
      currentBlock.push(curr);
    } else {
      blocks.push(currentBlock);
      currentBlock = [curr];
    }
  }
  blocks.push(currentBlock);

  // ブロックをテキスト要素として出力
  return blocks.map(function(block) {
    var text = block.map(function(l) { return l.content; }).join('\n');
    var minX = Math.min.apply(null, block.map(function(l) { return l.x; }));
    var minY = Math.min.apply(null, block.map(function(l) { return l.y; }));
    var maxRight = Math.max.apply(null, block.map(function(l) { return l.x + l.width; }));
    var maxBottom = Math.max.apply(null, block.map(function(l) { return l.y + l.height; }));
    var maxFontSize = Math.max.apply(null, block.map(function(l) { return l.fontSize; }));

    return {
      content: text,
      x: Math.max(0, minX),
      y: Math.max(0, minY),
      width: Math.min(1.0, maxRight - minX),
      height: Math.min(1.0, maxBottom - minY),
      fontSize: maxFontSize,
      bold: maxFontSize > 16
    };
  });
}

// ========================================================
// PDF ネイティブ要素抽出: 画像
// ========================================================

/**
 * page.getOperatorList() から埋め込み画像を抽出
 * transform行列を追跡して画像の位置とサイズを特定
 * page.objs.get() で実際の画像データを取得
 */
async function extractImageElements(page) {
  var viewport = page.getViewport({ scale: 1.0 });
  var pageWidth = viewport.width;
  var pageHeight = viewport.height;

  var opList = await page.getOperatorList();
  var fnArray = opList.fnArray;
  var argsArray = opList.argsArray;

  // グラフィックス状態スタック（変換行列の追跡）
  var ctmStack = [];
  // 初期CTM: 単位行列
  var currentCTM = [1, 0, 0, 1, 0, 0];

  var imageInfos = []; // {name, ctm} のリスト

  for (var i = 0; i < fnArray.length; i++) {
    var fn = fnArray[i];

    if (fn === OPS.save) {
      ctmStack.push(currentCTM.slice());
    } else if (fn === OPS.restore) {
      if (ctmStack.length > 0) currentCTM = ctmStack.pop();
    } else if (fn === OPS.transform) {
      // 行列の乗算: newCTM = args * currentCTM
      var m = argsArray[i];
      currentCTM = multiplyMatrix(m, currentCTM);
    } else if (fn === OPS.paintImageXObject || fn === OPS.paintJpegXObject) {
      var imgName = argsArray[i][0];
      imageInfos.push({
        name: imgName,
        ctm: currentCTM.slice()
      });
    }
  }

  debugLog('画像オペレータ検出数: ' + imageInfos.length);

  // 画像オブジェクトを取得してbase64に変換
  var imageElements = [];

  for (var i = 0; i < imageInfos.length; i++) {
    var info = imageInfos[i];
    var ctm = info.ctm;

    // CTMから位置とサイズを計算
    // PDF画像は1x1ユニット正方形に描画され、CTMでスケール・配置される
    // ctm = [a, b, c, d, e, f] → 幅=a, 高さ=d, x=e, y=f (単純なケース)
    var imgWidth = Math.sqrt(ctm[0] * ctm[0] + ctm[1] * ctm[1]);
    var imgHeight = Math.sqrt(ctm[2] * ctm[2] + ctm[3] * ctm[3]);
    var imgX = ctm[4];
    var imgY = ctm[5];

    // 極小画像（装飾ドット等）はスキップ
    if (imgWidth < 5 || imgHeight < 5) continue;

    // PDF座標→正規化座標（左上原点、0-1）
    var normX = imgX / pageWidth;
    var normY = (pageHeight - imgY - imgHeight) / pageHeight;
    var normW = imgWidth / pageWidth;
    var normH = imgHeight / pageHeight;

    // 範囲をクランプ
    normX = Math.max(0, Math.min(1, normX));
    normY = Math.max(0, Math.min(1, normY));
    normW = Math.max(0.01, Math.min(1 - normX, normW));
    normH = Math.max(0.01, Math.min(1 - normY, normH));

    // 全ページ画像（95%以上のサイズ）はスキップ → 背景として扱う
    if (normW > 0.95 && normH > 0.95) {
      debugLog('全ページ画像をスキップ: ' + info.name + ' (' + Math.round(normW*100) + '% x ' + Math.round(normH*100) + '%)');
      continue;
    }

    // 画像データを取得
    try {
      var imgData = await getImageAsBase64(page, info.name);
      if (imgData) {
        imageElements.push({
          data: imgData,
          mimeType: 'image/png',
          x: normX,
          y: normY,
          width: normW,
          height: normH
        });
        debugLog('画像抽出: ' + info.name + ' @ (' + normX.toFixed(2) + ',' + normY.toFixed(2) + ') ' + Math.round(normW*100) + '%x' + Math.round(normH*100) + '%');
      }
    } catch (e) {
      debugLog('画像取得エラー: ' + info.name + ' - ' + e.message);
    }
  }

  return imageElements;
}

/**
 * 2つの3x2行列を乗算
 * [a1, b1, c1, d1, e1, f1] * [a2, b2, c2, d2, e2, f2]
 */
function multiplyMatrix(m1, m2) {
  return [
    m1[0] * m2[0] + m1[2] * m2[1],
    m1[1] * m2[0] + m1[3] * m2[1],
    m1[0] * m2[2] + m1[2] * m2[3],
    m1[1] * m2[2] + m1[3] * m2[3],
    m1[0] * m2[4] + m1[2] * m2[5] + m1[4],
    m1[1] * m2[4] + m1[3] * m2[5] + m1[5]
  ];
}

/**
 * PDF.jsの page.objs から画像データを取得し、Canvasで base64 PNG に変換
 */
function getImageAsBase64(page, imageName) {
  return new Promise(function(resolve, reject) {
    try {
      page.objs.get(imageName, function(imgObj) {
        try {
          if (!imgObj) {
            resolve(null);
            return;
          }

          // imgObj は HTMLImageElement (JPEG) または {width, height, data} (raw bitmap)
          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');

          if (imgObj instanceof HTMLImageElement || imgObj.src) {
            // JPEG画像: HTMLImageElement
            canvas.width = imgObj.naturalWidth || imgObj.width;
            canvas.height = imgObj.naturalHeight || imgObj.height;
            ctx.drawImage(imgObj, 0, 0);
          } else if (imgObj.data && imgObj.width && imgObj.height) {
            // Raw bitmap データ: {width, height, data: Uint8ClampedArray}
            canvas.width = imgObj.width;
            canvas.height = imgObj.height;

            var imageData;
            if (imgObj.data.length === imgObj.width * imgObj.height * 4) {
              // RGBA データ
              imageData = new ImageData(
                new Uint8ClampedArray(imgObj.data),
                imgObj.width,
                imgObj.height
              );
            } else if (imgObj.data.length === imgObj.width * imgObj.height * 3) {
              // RGB データ → RGBA に変換
              var rgba = new Uint8ClampedArray(imgObj.width * imgObj.height * 4);
              for (var j = 0, k = 0; j < imgObj.data.length; j += 3, k += 4) {
                rgba[k] = imgObj.data[j];
                rgba[k + 1] = imgObj.data[j + 1];
                rgba[k + 2] = imgObj.data[j + 2];
                rgba[k + 3] = 255;
              }
              imageData = new ImageData(rgba, imgObj.width, imgObj.height);
            } else {
              // データサイズが合わない場合はスキップ
              canvas.width = 0;
              canvas.height = 0;
              resolve(null);
              return;
            }

            ctx.putImageData(imageData, 0, 0);
          } else {
            canvas.width = 0;
            canvas.height = 0;
            resolve(null);
            return;
          }

          // Canvas → base64 PNG
          var dataUrl = canvas.toDataURL('image/png');
          var base64 = dataUrl.split(',')[1];
          canvas.width = 0;
          canvas.height = 0;
          resolve(base64);
        } catch (innerErr) {
          resolve(null);
        }
      });
    } catch (e) {
      reject(e);
    }
  });
}

// ========================================================
// 背景色の検出
// ========================================================

/**
 * OperatorList から背景色を推定
 * 最初の大きな矩形の塗りつぶし色を背景色とする
 */
async function detectBackgroundColor(page) {
  var viewport = page.getViewport({ scale: 1.0 });
  var pageWidth = viewport.width;
  var pageHeight = viewport.height;

  var opList = await page.getOperatorList();
  var fnArray = opList.fnArray;
  var argsArray = opList.argsArray;

  var currentFillColor = '#FFFFFF';
  var bgColor = '#FFFFFF';

  for (var i = 0; i < fnArray.length; i++) {
    var fn = fnArray[i];

    if (fn === OPS.setFillRGBColor) {
      var r = Math.round(argsArray[i][0] * 255);
      var g = Math.round(argsArray[i][1] * 255);
      var b = Math.round(argsArray[i][2] * 255);
      currentFillColor = '#' + toHex(r) + toHex(g) + toHex(b);
    } else if (fn === OPS.constructPath) {
      // 大きな矩形を探す
      var ops = argsArray[i][0];
      var args = argsArray[i][1];
      // rectangle op = 19 in PDF.js (OPS.rectangle)
      if (ops && ops.length >= 1) {
        for (var j = 0; j < ops.length; j++) {
          if (ops[j] === 19 && args.length >= (j * 4 + 4)) { // rectangle
            var rw = Math.abs(args[j * 4 + 2]);
            var rh = Math.abs(args[j * 4 + 3]);
            // ページの80%以上を覆う矩形は背景
            if (rw > pageWidth * 0.8 && rh > pageHeight * 0.8) {
              bgColor = currentFillColor;
              debugLog('背景色検出: ' + bgColor);
              return bgColor;
            }
          }
        }
      }
    }
  }

  // 背景矩形が見つからない場合、ページをごく小さく描画して左上ピクセルから推定
  try {
    var miniCanvas = document.createElement('canvas');
    miniCanvas.width = 10;
    miniCanvas.height = 10;
    var miniCtx = miniCanvas.getContext('2d');
    var miniVp = page.getViewport({ scale: 10 / pageWidth });
    await page.render({ canvasContext: miniCtx, viewport: miniVp }).promise;
    var pixel = miniCtx.getImageData(1, 1, 1, 1).data;
    bgColor = '#' + toHex(pixel[0]) + toHex(pixel[1]) + toHex(pixel[2]);
    miniCanvas.width = 0;
    miniCanvas.height = 0;
    debugLog('背景色（ピクセル推定）: ' + bgColor);
  } catch (e) {
    debugLog('背景色検出失敗、白を使用');
  }

  return bgColor;
}

function toHex(n) {
  var h = n.toString(16);
  return h.length < 2 ? '0' + h : h;
}

// ========================================================
// テキスト色の検出（Canvasレンダリングから推定）
// ========================================================

/**
 * テキストの色を推定するために、ページをレンダリングしてテキスト位置のピクセル色を取得
 */
async function detectTextColors(page, textBlocks) {
  if (textBlocks.length === 0) return textBlocks;

  var viewport = page.getViewport({ scale: 1.0 });
  var canvas = document.createElement('canvas');
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  var ctx = canvas.getContext('2d');
  await page.render({ canvasContext: ctx, viewport: viewport }).promise;

  for (var i = 0; i < textBlocks.length; i++) {
    var block = textBlocks[i];
    // テキスト領域の中心付近のピクセル色を取得
    var px = Math.round((block.x + block.width * 0.1) * viewport.width);
    var py = Math.round((block.y + block.height * 0.5) * viewport.height);
    px = Math.max(0, Math.min(viewport.width - 1, px));
    py = Math.max(0, Math.min(viewport.height - 1, py));

    var pixel = ctx.getImageData(px, py, 1, 1).data;
    block.fontColor = '#' + toHex(pixel[0]) + toHex(pixel[1]) + toHex(pixel[2]);
  }

  canvas.width = 0;
  canvas.height = 0;
  return textBlocks;
}

// ========================================================
// 1ページの全要素を抽出
// ========================================================

async function extractPageElements(page, pageNum) {
  debugLog('--- ページ ' + pageNum + ' 解析開始 ---');

  var viewport = page.getViewport({ scale: 1.0 });
  var pageWidth = viewport.width;
  var pageHeight = viewport.height;

  // 並列実行: テキスト・画像・背景色を同時に抽出
  var results = await Promise.all([
    extractTextElements(page),
    extractImageElements(page),
    detectBackgroundColor(page)
  ]);

  var rawTextElements = results[0];
  var imageElements = results[1];
  var backgroundColor = results[2];

  debugLog('テキスト要素: ' + rawTextElements.length + '個');
  debugLog('画像要素: ' + imageElements.length + '個');
  debugLog('背景色: ' + backgroundColor);

  // テキストをグループ化
  var textBlocks = groupTextElements(rawTextElements, pageWidth, pageHeight);
  debugLog('テキストブロック（グループ化後）: ' + textBlocks.length + '個');

  // テキスト色を検出
  textBlocks = await detectTextColors(page, textBlocks);

  // テキストブロックの内容をログ
  for (var i = 0; i < textBlocks.length; i++) {
    var tb = textBlocks[i];
    debugLog('  [テキスト] "' + tb.content.substring(0, 40) + '..." fontSize=' + Math.round(tb.fontSize) + ' color=' + (tb.fontColor || '?'));
  }

  return {
    backgroundColor: backgroundColor,
    texts: textBlocks,
    images: imageElements
  };
}

// ========================================================
// スライド作成メイン処理
// ========================================================

async function startCreation() {
  if (uploadedFiles.length === 0) return;

  var btn = document.getElementById('createBtn');
  btn.disabled = true;
  document.getElementById('createResult').innerHTML = '';
  document.getElementById('debugLog').textContent = '';
  document.getElementById('debugLog').classList.remove('show');
  document.getElementById('createProgressBar').classList.remove('hidden');
  showProgress('createProgress', '処理を開始...');

  try {
    await startCreationNative();
  } catch (err) {
    hideProgress('createProgress');
    document.getElementById('createProgressBar').classList.add('hidden');
    showResult('createResult', 'error', escHtml(err.message || String(err)));
    debugLog('エラー: ' + (err.message || String(err)));
  } finally {
    btn.disabled = false;
  }
}

// ========================================================
// ネイティブ抽出フロー
// ========================================================

async function startCreationNative() {
  var allPages = [];
  var totalFiles = uploadedFiles.length;
  var totalPagesSoFar = 0;
  var estimatedTotalPages = 0;

  // まずPDFのページ数を事前計算
  for (var f = 0; f < totalFiles; f++) {
    var file = uploadedFiles[f];
    if (file.type === 'application/pdf') {
      var ab = await file.arrayBuffer();
      var pdf = await pdfjsLib.getDocument({ data: ab }).promise;
      estimatedTotalPages += pdf.numPages;
      // pdf を一旦保持
      file._pdf = pdf;
    }
  }

  debugLog('合計ページ数: ' + estimatedTotalPages);

  // 各ページを解析
  for (var f = 0; f < totalFiles; f++) {
    var file = uploadedFiles[f];

    if (file.type === 'application/pdf') {
      var pdf = file._pdf;
      if (!pdf) {
        var ab = await file.arrayBuffer();
        pdf = await pdfjsLib.getDocument({ data: ab }).promise;
      }
      var numPages = pdf.numPages;

      for (var p = 1; p <= numPages; p++) {
        totalPagesSoFar++;
        var pct = (totalPagesSoFar / estimatedTotalPages) * 70;
        updateProgress(escHtml(file.name) + ' p.' + p + '/' + numPages + ' 解析中...', pct);

        var page = await pdf.getPage(p);
        var pageData = await extractPageElements(page, totalPagesSoFar);

        // テキストも画像もない場合、フォールバック: ページ全体を画像として描画
        if (pageData.texts.length === 0 && pageData.images.length === 0) {
          debugLog('ページ ' + totalPagesSoFar + ': テキスト・画像なし → 全体画像フォールバック');
          var viewport = page.getViewport({ scale: 2.0 });
          var canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          var ctx = canvas.getContext('2d');
          await page.render({ canvasContext: ctx, viewport: viewport }).promise;
          var fallbackData = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
          pageData.images = [{ data: fallbackData, mimeType: 'image/jpeg', x: 0, y: 0, width: 1.0, height: 1.0 }];
          canvas.width = 0;
          canvas.height = 0;
        }

        allPages.push(pageData);
      }

      delete file._pdf;
    }
  }

  if (allPages.length === 0) throw new Error('ページデータがありません。');

  debugLog('=== 全ページ解析完了 (' + allPages.length + 'ページ) ===');
  debugLog('サーバーへ送信開始...');

  // Phase 2: バッチでサーバーに送信してスライド作成
  var title = document.getElementById('createTitle').value;
  var shareMode = document.getElementById('createShareMode').value;
  var emails = document.getElementById('createEmails').value;
  var permission = document.getElementById('createPermission').value;
  var presentationId = null;
  var totalSlides = allPages.length;

  for (var batchStart = 0; batchStart < allPages.length; batchStart += BATCH_SIZE) {
    var batch = allPages.slice(batchStart, batchStart + BATCH_SIZE);
    var batchEnd = Math.min(batchStart + BATCH_SIZE, allPages.length);
    var pct = 70 + (batchEnd / totalSlides) * 30;
    updateProgress('スライド作成中... (' + batchEnd + '/' + totalSlides + ')', pct);
    debugLog('バッチ送信: ページ ' + (batchStart + 1) + '〜' + batchEnd);

    // バッチサイズを計算してログ
    var batchJson = JSON.stringify(batch);
    debugLog('  バッチデータサイズ: ' + (batchJson.length / 1024 / 1024).toFixed(2) + ' MB');

    // データが大きすぎる場合は1ページずつ送信
    if (batchJson.length > 5 * 1024 * 1024) {
      debugLog('  データが大きいため1ページずつ送信');
      for (var si = 0; si < batch.length; si++) {
        var singlePage = [batch[si]];
        if (presentationId === null) {
          var result = await callServer('createPresentationFromAnalysis', {
            pages: singlePage, title: title, shareMode: shareMode, emails: emails, permission: permission
          });
          presentationId = result.id;
          debugLog('  プレゼンテーション作成: ' + presentationId);
        } else {
          await callServer('addSlidesFromAnalysis', { presentationId: presentationId, pages: singlePage });
        }
      }
    } else {
      if (batchStart === 0) {
        var result = await callServer('createPresentationFromAnalysis', {
          pages: batch, title: title, shareMode: shareMode, emails: emails, permission: permission
        });
        presentationId = result.id;
        debugLog('  プレゼンテーション作成: ' + presentationId);
      } else {
        await callServer('addSlidesFromAnalysis', { presentationId: presentationId, pages: batch });
      }
    }
  }

  // 完了
  hideProgress('createProgress');
  document.getElementById('createProgressBar').classList.add('hidden');
  var url = 'https://docs.google.com/presentation/d/' + presentationId + '/edit';
  showResult('createResult', 'success',
    '<strong>' + escHtml(title) + '</strong> を作成しました（' + totalSlides + ' スライド）<br>' +
    '<a href="' + url + '" target="_blank">Google スライドを開く</a><br>' +
    '<span style="font-size:12px;color:var(--text-sub)">テキスト・画像・背景が個別の編集可能な要素として配置されています。</span><br>' +
    '<span style="font-size:12px;color:var(--text-sub)">ID: ' + presentationId + '</span>'
  );
  debugLog('=== 完了 ===');
  uploadedFiles = [];
  renderFileList();
}

// ========================================================
// ユーティリティ
// ========================================================

function callServer(functionName, arg) {
  return new Promise(function(resolve, reject) {
    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[functionName](arg);
  });
}

function updateProgress(text, percent) {
  showProgress('createProgress', text);
  if (percent !== undefined) document.getElementById('progressBar').style.width = Math.round(percent) + '%';
}

// ========================================================
// 編集機能
// ========================================================
function loadPresentations() {
  google.script.run.withSuccessHandler(function(list) {
    var sel = document.getElementById('editPresentationSelect');
    sel.innerHTML = '<option value="">-- 選択してください --</option>';
    list.forEach(function(p) {
      var date = new Date(p.lastUpdated).toLocaleDateString('ja-JP');
      sel.innerHTML += '<option value="' + p.id + '">' + escHtml(p.name) + ' (' + date + ')</option>';
    });
  }).listMyPresentations();
}
function onPresentationSelected() {
  var id = document.getElementById('editPresentationSelect').value;
  if (id) { document.getElementById('editPresentationId').value = id; loadStructure(); }
}
function loadStructure() {
  var id = getEditId(); if (!id) return;
  showProgress('editProgress');
  google.script.run
    .withSuccessHandler(function(s) { hideProgress('editProgress'); document.getElementById('editPanel').classList.remove('hidden'); renderStructure(s); })
    .withFailureHandler(function(e) { hideProgress('editProgress'); showResult('structureView', 'error', escHtml(e.message)); })
    .getSlideStructure(id);
}
function renderStructure(structure) {
  var html = '<table class="structure-table"><tr><th>#</th><th>種類</th><th>位置</th><th>サイズ</th><th>内容</th></tr>';
  structure.forEach(function(s) {
    html += '<tr class="slide-header"><td colspan="5">スライド ' + s.slideNumber + '</td></tr>';
    s.elements.forEach(function(el) {
      var content = '';
      if (el.type === 'SHAPE' && el.text) content = escHtml(el.text.substring(0, 60));
      else if (el.type === 'IMAGE') content = '[画像]';
      html += '<tr><td>' + el.index + '</td><td>' + el.type + '</td><td>' + el.left + ', ' + el.top + '</td><td>' + el.width + ' x ' + el.height + '</td><td>' + content + '</td></tr>';
    });
  });
  html += '</table>';
  document.getElementById('structureView').innerHTML = html;
}
function doReplaceText() {
  var id = getEditId(), s = document.getElementById('searchText').value, r = document.getElementById('replaceTextVal').value;
  if (!id || !s) return;
  google.script.run.withSuccessHandler(function(c) { showResult('replaceResult', 'success', c + ' 箇所を置換しました。'); loadStructure(); })
    .withFailureHandler(function(e) { showResult('replaceResult', 'error', escHtml(e.message)); }).replaceText(id, s, r);
}
function doAddTextBox() {
  var id = getEditId(); if (!id) return;
  var sn = parseInt(document.getElementById('tbSlide').value)||1, txt = document.getElementById('tbText').value,
      l = parseFloat(document.getElementById('tbLeft').value)||50, t = parseFloat(document.getElementById('tbTop').value)||50,
      w = parseFloat(document.getElementById('tbWidth').value)||300, h = parseFloat(document.getElementById('tbHeight').value)||50,
      fs = parseInt(document.getElementById('tbFontSize').value)||18;
  google.script.run.withSuccessHandler(function() { showResult('tbResult', 'success', 'テキストボックスを追加しました。'); loadStructure(); })
    .withFailureHandler(function(e) { showResult('tbResult', 'error', escHtml(e.message)); }).addTextBox(id, sn, txt, l, t, w, h, fs);
}
function doReplaceImage() {
  var id = getEditId(); if (!id) return;
  var sn = parseInt(document.getElementById('imgSlide').value)||1, idx = parseInt(document.getElementById('imgIndex').value)||1;
  var url = document.getElementById('imgUrl').value.trim(), fi = document.getElementById('imgFile');
  if (url) {
    google.script.run.withSuccessHandler(function() { showResult('imgResult', 'success', '画像を差し替えました。'); loadStructure(); })
      .withFailureHandler(function(e) { showResult('imgResult', 'error', escHtml(e.message)); }).replaceImage(id, sn, idx, {url:url});
  } else if (fi.files.length > 0) {
    var reader = new FileReader(); reader.onload = function() {
      var d = {data: reader.result.split(',')[1], mimeType: fi.files[0].type, fileName: fi.files[0].name};
      google.script.run.withSuccessHandler(function() { showResult('imgResult', 'success', '画像を差し替えました。'); loadStructure(); })
        .withFailureHandler(function(e) { showResult('imgResult', 'error', escHtml(e.message)); }).replaceImage(id, sn, idx, d);
    }; reader.readAsDataURL(fi.files[0]);
  } else { showResult('imgResult', 'error', '画像ファイルまたは URL を指定してください。'); }
}

// ========================================================
// 共有管理
// ========================================================
function loadSharingInfo() {
  var id = document.getElementById('sharePresentationId').value.trim(); if (!id) return;
  showProgress('shareProgress');
  google.script.run.withSuccessHandler(function(info) { hideProgress('shareProgress'); document.getElementById('sharePanel').classList.remove('hidden'); renderSharingInfo(info); })
    .withFailureHandler(function(e) { hideProgress('shareProgress'); showResult('shareResult', 'error', escHtml(e.message)); }).getSharingInfo(id);
}
function renderSharingInfo(info) {
  var am = {'ANYONE':'全員','ANYONE_WITH_LINK':'リンクを知っている全員','DOMAIN':'ドメイン内','PRIVATE':'非公開'};
  var pm = {'VIEW':'閲覧のみ','EDIT':'編集可','COMMENT':'コメント可','NONE':'なし'};
  var h = '<dt>アクセス範囲</dt><dd>'+(am[info.access]||info.access)+'</dd>';
  h += '<dt>権限</dt><dd>'+(pm[info.permission]||info.permission)+'</dd>';
  h += '<dt>編集者</dt><dd>'+(info.editors.length>0?escHtml(info.editors.join(', ')):'なし')+'</dd>';
  h += '<dt>閲覧者</dt><dd>'+(info.viewers.length>0?escHtml(info.viewers.join(', ')):'なし')+'</dd>';
  h += '<dt>URL</dt><dd><a href="'+info.url+'" target="_blank">'+escHtml(info.url)+'</a></dd>';
  document.getElementById('shareInfoView').innerHTML = h;
}
function doUpdateSharing() {
  var id = document.getElementById('sharePresentationId').value.trim(); if (!id) return;
  google.script.run.withSuccessHandler(function(info) { showResult('shareResult', 'success', '共有設定を更新しました。'); renderSharingInfo(info); })
    .withFailureHandler(function(e) { showResult('shareResult', 'error', escHtml(e.message)); })
    .updateSharing(id, document.getElementById('shareMode').value, document.getElementById('shareEmails').value, document.getElementById('sharePermission').value);
}

// ========================================================
// 共通ユーティリティ
// ========================================================
function getEditId() { return document.getElementById('editPresentationId').value.trim(); }
function toggleEmailSection(prefix) {
  var mode = document.getElementById(prefix + (prefix === 'create' ? 'ShareMode' : 'Mode')).value;
  document.getElementById(prefix + 'EmailSection').classList.toggle('hidden', mode !== 'emails');
}
function showProgress(id, text) { var el = document.getElementById(id); el.classList.add('show'); if (text) { var s = el.querySelector('span'); if (s) s.textContent = text; } }
function hideProgress(id) { document.getElementById(id).classList.remove('show'); }
function showResult(cid, type, html) { document.getElementById(cid).innerHTML = '<div class="result '+type+'">'+html+'</div>'; }
function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
</script>
</body>
</html>
